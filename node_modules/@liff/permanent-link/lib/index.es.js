import{__awaiter as t,__generator as n,__extends as r}from"tslib";import{UNKNOWN as e,INIT_FAILED as i,INVALID_CONFIG as o,CREDENTIAL_KEYS as a,PERMANENT_LINK_ORIGIN as s,INVALID_ARGUMENT as c}from"@liff/consts";import{createLiffError as f}from"@liff/util";import{getContext as u,getConfig as l}from"@liff/store";import{LiffModule as p}from"@liff/use";import{getEndPoint as h}from"@liff/server-api";function m(r){return t(this,void 0,void 0,(function(){var t,i;return n(this,(function(n){switch(n.label){case 0:return[4,fetch(h("permanentLink"),{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"POST",body:JSON.stringify(r)})];case 1:return(t=n.sent()).ok?[3,3]:[4,t.json()];case 2:throw i=n.sent().message,f(e,i);case 3:return[4,t.json()];case 4:return[2,n.sent()]}}))}))}var d=function(e){function p(){var r=null!==e&&e.apply(this,arguments)||this;return r.extraParams="",r.getAndValidateContext=function(){var t=u();if(!t)throw f(i,"Could not get Context from server.");if(!t.endpointUrl)throw f(i,"Could not get endpointUrl from server.");if(!t.permanentLinkPattern)throw f(i,"Could not get permanentLinkPattern from server.");return t},r.createUrl=function(){var t=r.getAndValidateContext(),n=window.location,e=n.pathname,i=n.search,c=n.hash,u=n.origin,p=new URL(t.endpointUrl);if(p.origin!==u||!r.isAncestor(p.pathname,e))throw f(o,"Current page is not under entrypoint.");var h=e.substring(p.pathname.length);h.length>0&&"/"!==h[0]&&(h="/"+h);var m=new RegExp("^".concat(a.join("|"))),d=c.substring(1).split("&").filter((function(t){return!m.test(t)&&Boolean(t)})).join("&"),g=d===p.hash.substring(1)?"":d,v=function(t){return t.substring(1).split("&").filter((function(t){return!/liff\.state/.test(t)&&Boolean(t)}))},w=v(i),x=v(p.search);r.extraParams&&w.push(r.extraParams);for(var y=0;y<x.length;y++){var U=x[y],b=w.indexOf(U);b>-1&&w.splice(b,1)}var P=w.join("&"),j="".concat(h).concat(""!==P?"?".concat(P):"").concat(g?"#".concat(g):"");return"".concat(s).concat(l().liffId).concat(j)},r.createUrlBy=function(e){return t(r,void 0,void 0,(function(){var t,r;return n(this,(function(n){switch(n.label){case 0:if(!(t=l().liffId))throw f(i,"Should run after liff init.");try{r=new URL(e)}catch(o){throw f(c,"invalid URL.")}return[4,m({liffId:t,currentPageUrl:r.toString()})];case 1:return[2,n.sent().permanentLinkUrl]}}))}))},r.setExtraQueryParam=function(t){r.extraParams=t},r.isAncestor=function(t,n){return 0===n.indexOf(t)&&(t.endsWith("/")&&(t=t.substring(0,t.length-1)),void 0===n[t.length]||"/"===n[t.length])},r.install=function(){return{createUrl:r.createUrl,createUrlBy:r.createUrlBy,setExtraQueryParam:r.setExtraQueryParam}},r}return r(p,e),Object.defineProperty(p.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),p}(p),g=new d;export{d as PermanentLinkModule,g as module};
