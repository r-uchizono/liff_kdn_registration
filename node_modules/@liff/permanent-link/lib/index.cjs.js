"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),r=require("@liff/consts"),t=require("@liff/util"),n=require("@liff/store"),i=require("@liff/use"),a=require("@liff/server-api");function o(n){return e.__awaiter(this,void 0,void 0,(function(){var i,o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,fetch(a.getEndPoint("permanentLink"),{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"POST",body:JSON.stringify(n)})];case 1:return(i=e.sent()).ok?[3,3]:[4,i.json()];case 2:throw o=e.sent().message,t.createLiffError(r.UNKNOWN,o);case 3:return[4,i.json()];case 4:return[2,e.sent()]}}))}))}var s=function(i){function a(){var a=null!==i&&i.apply(this,arguments)||this;return a.extraParams="",a.getAndValidateContext=function(){var e=n.getContext();if(!e)throw t.createLiffError(r.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw t.createLiffError(r.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw t.createLiffError(r.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},a.createUrl=function(){var e=a.getAndValidateContext(),i=window.location,o=i.pathname,s=i.search,c=i.hash,f=i.origin,u=new URL(e.endpointUrl);if(u.origin!==f||!a.isAncestor(u.pathname,o))throw t.createLiffError(r.INVALID_CONFIG,"Current page is not under entrypoint.");var l=o.substring(u.pathname.length);l.length>0&&"/"!==l[0]&&(l="/"+l);var d=new RegExp("^".concat(r.CREDENTIAL_KEYS.join("|"))),h=c.substring(1).split("&").filter((function(e){return!d.test(e)&&Boolean(e)})).join("&"),g=h===u.hash.substring(1)?"":h,p=function(e){return e.substring(1).split("&").filter((function(e){return!/liff\.state/.test(e)&&Boolean(e)}))},L=p(s),m=p(u.search);a.extraParams&&L.push(a.extraParams);for(var I=0;I<m.length;I++){var v=m[I],E=L.indexOf(v);E>-1&&L.splice(E,1)}var _=L.join("&"),x="".concat(l).concat(""!==_?"?".concat(_):"").concat(g?"#".concat(g):"");return"".concat(r.PERMANENT_LINK_ORIGIN).concat(n.getConfig().liffId).concat(x)},a.createUrlBy=function(i){return e.__awaiter(a,void 0,void 0,(function(){var a,s;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(a=n.getConfig().liffId))throw t.createLiffError(r.INIT_FAILED,"Should run after liff init.");try{s=new URL(i)}catch(c){throw t.createLiffError(r.INVALID_ARGUMENT,"invalid URL.")}return[4,o({liffId:a,currentPageUrl:s.toString()})];case 1:return[2,e.sent().permanentLinkUrl]}}))}))},a.setExtraQueryParam=function(e){a.extraParams=e},a.isAncestor=function(e,r){return 0===r.indexOf(e)&&(e.endsWith("/")&&(e=e.substring(0,e.length-1)),void 0===r[e.length]||"/"===r[e.length])},a.install=function(){return{createUrl:a.createUrl,createUrlBy:a.createUrlBy,setExtraQueryParam:a.setExtraQueryParam}},a}return e.__extends(a,i),Object.defineProperty(a.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),a}(i.LiffModule),c=new s;exports.PermanentLinkModule=s,exports.module=c;
