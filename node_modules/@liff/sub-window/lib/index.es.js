import{__awaiter as e,__generator as t,__read as n,__spreadArray as r,__extends as i}from"tslib";import{LiffModule as o}from"@liff/use";import{isInClient as s}from"@liff/is-in-client";import{validators as u}from"@liff/is-api-available";import{STORE_KEY as a,INVALID_CONFIG as c,EXCEPTION_IN_SUBWINDOW as f,SUB_WINDOW_STATUS as l,CREATE_SUBWINDOW_FAILED as d,SUB_WINDOW_IDNTIFICATION_KEY as m,INVALID_ARGUMENT as v,SUB_WINDOW_HEALTH_CHECK_MESSAGE as p,SUB_WINDOW_HEALTH_CHECK_INTERVAL as h,SUB_WINDOW_MONITOR_CLOSE_INTERVAL as w,UNKNOWN as g,UNAUTHORIZED as b,SUB_WINDOW_MODAL_SCHEME_URL as y}from"@liff/consts";import{logger as S}from"@liff/logger";import{createLiffError as I,inMemoryStorage as O,isIpad as P,extractLiffId as C}from"@liff/util";import{getOS as L}from"@liff/get-os";import{getEndPoint as E,fetch as N,requestWithoutErrorHandling as T}from"@liff/server-api";import{getConfig as j,getMSTChallenge as M,getMST as D,getAppData as B}from"@liff/store";import{WINDOW as J,MessageBus as R,IDENTIFIER_KEY as U,CRYPTO_KEY as W}from"@liff/message-bus";import{isSubWindow as A}from"@liff/is-sub-window";import{closeWindow as x}from"@liff/close-window";function k(e){var t=E("subWindowGetOrigin");return N(t(e))}var K={};function G(e,t){e&&K[e]&&K[e].forEach((function(e){e(t)}))}var V,F,_,q,z,H=function(){function e(e){this.storage=e}return e.prototype.getItem=function(e){return this.storage.getItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.setItem=function(e,t){this.storage.setItem("".concat(this.getKeyPrefix(),":").concat(e),t)},e.prototype.removeItem=function(e){this.storage.removeItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.clear=function(){this.storage.clear()},e.prototype.getKeyPrefix=function(){return"".concat(a,":").concat(this.getLiffId())},e.prototype.getLiffId=function(){var e=j().liffId;if(!e)throw I(c,"liffId is necessary for liff.init()");return e},e}(),Q=new H(O);function X(){var e=Q.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function Y(e){Q.setItem("subWindowStatusUpdated",String(e))}function Z(e){V=e}function $(){return V}function ee(){return _}function te(){return q}function ne(n){return void 0===n&&(n=J.MAIN),e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,(z=new R(n)).setup()];case 1:return e.sent(),[2,z]}}))}))}function re(){return z}var ie=new H(window.sessionStorage);function oe(e){ie.setItem("mainWindowOrigin",e)}function se(){return ie.getItem("mainWindowOrigin")}function ue(n,r){return void 0===r&&(r={}),e(this,void 0,void 0,(function(){var e,i,o,s,u,a,c,d;return t(this,(function(t){switch(t.label){case 0:if(null==(e=re())?void 0:e.isReady())return[3,5];if(i=JSON.stringify(r),o=j().liffId,s=se(),!window.opener||!s||!o)throw I(f);u=!1,t.label=1;case 1:return t.trys.push([1,3,,4]),[4,k(o)];case 2:return a=t.sent(),u=a.subwindowCommonModule,[3,4];case 3:throw c=t.sent(),S.debug(c),I(f);case 4:return d=u?s:location.origin,[2,new Promise((function(e){window.addEventListener("message",(function t(r){(function(e){if(e.data&&"string"==typeof e.data.type&&[l.SUBMIT,l.CANCEL].includes(e.data.type))return!0;return!1})(r)&&(window.removeEventListener("message",t),e({status:n,result:i}))})),window.opener.postMessage({status:n,result:i},d)}))];case 5:return e.send({eventName:n,data:r}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return t.sent(),[2,{status:n,result:JSON.stringify(r)}]}}))}))}function ae(e){var t,n=te();if(e.origin===n){var r=e.data;if(r){var i,o=r.status,s=r.result;try{i=JSON.parse(s||"{}")}catch(u){i={}}switch(o){case p:window.clearInterval(ee()),de();break;case l.CANCEL:case l.SUBMIT:Y(!0),window.clearInterval(ee()),window.removeEventListener("message",ae),G(o,i),null===(t=$())||void 0===t||t.postMessage({type:o},te());break;default:S.debug("unexpected message")}}}}var ce=function(n){return e(void 0,void 0,void 0,(function(){var e,r,i,o;return t(this,(function(t){if(X())return[2];switch(e=n.context,r=e.eventName,i=e.data,o=re(),r){case l.INIT:le(!i.hasOpener);break;case l.CANCEL:case l.SUBMIT:Y(!0),G(r,i),null==o||o.reply(n,{eventName:r});break;case l.CLOSE:!1===X()&&(Y(!0),G(l.CLOSE,{})),de()}return[2]}))}))};function fe(){window.clearInterval(F),window.clearInterval(ee()),window.removeEventListener("message",ae)}function le(e){if(void 0===e&&(e=!1),fe(),Y(!1),e){var t=$();t&&(t.close(),Z(null))}}function de(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return(e=re())?[4,e.teardown()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}function me(i){return e(this,void 0,void 0,(function(){var e,o,s,u,a,c,f,g,b,y;return t(this,(function(t){switch(t.label){case 0:return(e=C(i.url))?(le(!0),[4,de()]):[2,Promise.reject(I(v,"params.url must be liff url"))];case 1:return t.sent(),o=i.url,s=i.appData,(u=new URL(o)).searchParams.append(m,"true"),[4,ne()];case 2:return a=t.sent(),u.searchParams.append(U,a.identification.identifier),u.searchParams.append(W,a.identification.cryptoKey),u.hostname=function(e){var t=n(e.split(".")),i=t[0],o=t.slice(1);return r(["".concat(i,"-ext")],n(o),!1).join(".")}(u.hostname),c=u.toString(),Z("ios"!==L()||P()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),[4,k(e)];case 3:if(f=t.sent(),g=f.origin,b=f.subwindowCommonModule,!(y=$()))throw I(d);return b?(function(e){q=e}(g),a.listen(ce),a.setData("appData",s),window.addEventListener("message",ae),y.location.href=c,S=function(e,t){var n=$(),r={type:p};return t&&(r.message=JSON.stringify(t)),window.setInterval((function(){null==n||n.postMessage(r,e)}),h)}(g,s),_=S,function(e){F=e}(window.setInterval((function(){var e=$();e&&e.closed&&(fe(),Z(null),!1===X()&&(Y(!0),G(l.CLOSE,{})))}),w)),[2]):(y.close(),[2])}var S}))}))}var ve=null;function pe(i){return e(this,void 0,void 0,(function(){var o,s,u,a,c,f,d,m,p,h,w,b,y,S,O=this;return t(this,(function(P){switch(P.label){case 0:if(o=i.msit,s=i.mstChallenge,u=i.reconnectCount,a=void 0===u?0:u,c=function(){return e(O,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,(t=1e3,new Promise((function(e){return setTimeout(e,t)})))];case 1:return e.sent(),[4,pe({msit:o,mstChallenge:s,onSuccess:i.onSuccess,onError:i.onError,reconnectCount:a+1})];case 2:return e.sent(),[2]}var t}))}))},f=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];ve=null,i.onSuccess.apply(i,r([],n(e),!1))},d=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];ve=null,i.onError.apply(i,r([],n(e),!1))},m=Date.now(),null===ve&&(ve=m),p=m-ve,a>=10||p>6e5)return d(I(g,"Failed to connect")),[2];P.label=1;case 1:return P.trys.push([1,3,,5]),[4,T(E("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:o,mstChallenge:s})})];case 2:return h=P.sent(),[3,5];case 3:return P.sent(),[4,c()];case 4:return P.sent(),[2];case 5:return h.status>=500?[4,c()]:[3,7];case 6:return P.sent(),[3,17];case 7:return h.status>=400&&500>h.status?[4,he(h)]:[3,9];case 8:return b=P.sent(),w=b?I(v,b.errorDetail):I(g,"Some error happened in the server"),d(w),[3,17];case 9:return 200!==h.status?[3,16]:[4,he(h)];case 10:if(!(b=P.sent()))return d(I(g,"Some error happened in the server")),[2];switch(y=b.status,S=b.result,y){case l.ERROR:return[3,11];case l.CLOSE:case l.CANCEL:case l.SUBMIT:return[3,13]}return[3,14];case 11:return[4,c()];case 12:return P.sent(),[3,15];case 13:return f(y,S),[3,15];case 14:d(I(g,"Some error happened in the server")),P.label=15;case 15:return[3,17];case 16:d(I(g,"Some error happened in the server")),P.label=17;case 17:return[2]}}))}))}function he(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.json()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}}))}))}function we(e){var t={};return Object.keys(e).forEach((function(n){"closeButtonColor"===n?"white"===e[n]?t[n]="#ffffff":t[n]="#000000":t[n]=e[n]})),t}var ge={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function be(e){var t=e.appData,n=e.native,r=j().liffId,i=M(),o=C(e.url);if(!r)return Promise.reject(I(b,"liffId is invalid"));if(!i)return Promise.reject(I(b,"mst_challenge is invalid"));if(!o)return Promise.reject(I(v,"params.url must be liff url"));var s=Object.assign({},ge,n);return function(e){var t=e.mainLiffId,n=e.subLiffId,r=e.mstChallenge,i=e.appData,o=e.view;return t&&r?N(E("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:n,mstChallenge:r,appData:i,view:o})}):Promise.reject(I(v,"no proper argument"))}({mainLiffId:r,subLiffId:o,mstChallenge:i,appData:t,view:we(s)}).then((function(t){var n=t.msit;pe({msit:n,mstChallenge:i,onSuccess:function(e,t){G(e,t)},onError:function(e){G(l.ERROR,e)}}),function(e,t){var n=e.url,r=new URLSearchParams;r.set("msit",t),location.href="".concat(y,"?url=").concat(encodeURIComponent(n),"&").concat(r.toString())}(e,n)}))}function ye(e){if(!e.mst||!e.status)return Promise.reject(I(v,"no proper argument"));var t=JSON.stringify(e);return N(E("subWindowPost"),{method:"POST",body:t})}function Se(){if(!A())throw I(b,"this api can be only called in child window")}function Ie(e){var t=e.msit,n=e.mstVerifier;return t&&n?N(E("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:n})}):Promise.reject(I(v,"no proper argument"))}function Oe(e){var t=e.mst;return t?N(E("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(I(v,"no proper argument"))}var Pe={on:function(e,t){K[e]||(K[e]=[]),K[e].push(t)},off:function(e,t){if(K[e]){var n=K[e].indexOf(t);n>=0&&K[e].splice(n,1)}},open:function(e){return u.subwindowOpen(),s()?be(e):me(e)},cancel:function(n){return void 0===n&&(n={}),Se(),s()?function(n){return void 0===n&&(n={}),e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return(e=D())?[4,ye({mst:e,status:l.CANCEL,result:n})]:[2,Promise.reject(I(b,"mst is invalid"))];case 1:return r=t.sent(),Y(!0),[2,r]}}))}))}(n):function(e){return void 0===e&&(e={}),ue(l.CANCEL,e)}(n)},submit:function(n){return void 0===n&&(n={}),Se(),s()?function(n){return void 0===n&&(n={}),e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return(e=D())?[4,ye({mst:e,status:l.SUBMIT,result:n})]:[2,Promise.reject(I(b,"mst is invalid"))];case 1:return r=t.sent(),Y(!0),[2,r]}}))}))}(n):function(e){return void 0===e&&(e={}),ue(l.SUBMIT,e)}(n)},close:function(){return Se(),s()?function(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return!1!==X()?[3,2]:(e=D())?[4,ye({mst:e,status:l.CLOSE,result:{}})]:[2,Promise.reject(I(b,"mst is invalid"))];case 1:t.sent(),t.label=2;case 2:return x(),[2]}}))}))}():function(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){return(null==(e=re())?void 0:e.isReady())?(e.send({eventName:l.CLOSE}),[2,new Promise((function(e){setTimeout((function(){x(),e()}),h)}))]):(x(),[2,Promise.resolve()])}))}))}()},getAppData:function(){return Se(),function(){var e,t=B();try{e=t?JSON.parse(t):{}}catch(n){e={}}return Promise.resolve(e)}()}},Ce=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return"subWindow"},enumerable:!1,configurable:!0}),t.prototype.install=function(){return Pe},t}(o);export{Ce as SubWindowModule,Oe as getAppData,Ie as getMSTByMSIT,se as getMainWindowOrigin,re as getMessageBus,ne as initMessageBus,oe as setMainWindowOrigin,Pe as subWindow};
