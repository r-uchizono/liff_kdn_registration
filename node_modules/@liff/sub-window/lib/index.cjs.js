"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/use"),r=require("@liff/is-in-client"),n=require("@liff/is-api-available"),i=require("@liff/consts"),o=require("@liff/logger"),s=require("@liff/util"),a=require("@liff/get-os"),u=require("@liff/server-api"),c=require("@liff/store"),f=require("@liff/message-bus"),l=require("@liff/is-sub-window"),d=require("@liff/close-window");function _(e){var t=u.getEndPoint("subWindowGetOrigin");return u.fetch(t(e))}var S={};function I(e,t){e&&S[e]&&S[e].forEach((function(e){e(t)}))}var v,g,p,m,w,h=function(){function e(e){this.storage=e}return e.prototype.getItem=function(e){return this.storage.getItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.setItem=function(e,t){this.storage.setItem("".concat(this.getKeyPrefix(),":").concat(e),t)},e.prototype.removeItem=function(e){this.storage.removeItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.clear=function(){this.storage.clear()},e.prototype.getKeyPrefix=function(){return"".concat(i.STORE_KEY,":").concat(this.getLiffId())},e.prototype.getLiffId=function(){var e=c.getConfig().liffId;if(!e)throw s.createLiffError(i.INVALID_CONFIG,"liffId is necessary for liff.init()");return e},e}(),N=new h(s.inMemoryStorage);function E(){var e=N.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function T(e){N.setItem("subWindowStatusUpdated",String(e))}function O(e){v=e}function W(){return v}function U(){return p}function L(){return m}function A(t){return void 0===t&&(t=f.WINDOW.MAIN),e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(w=new f.MessageBus(t)).setup()];case 1:return e.sent(),[2,w]}}))}))}function b(){return w}var D=new h(window.sessionStorage);function C(){return D.getItem("mainWindowOrigin")}function y(t,r){return void 0===r&&(r={}),e.__awaiter(this,void 0,void 0,(function(){var n,a,u,f,l,d,S,I;return e.__generator(this,(function(e){switch(e.label){case 0:if(null==(n=b())?void 0:n.isReady())return[3,5];if(a=JSON.stringify(r),u=c.getConfig().liffId,f=C(),!window.opener||!f||!u)throw s.createLiffError(i.EXCEPTION_IN_SUBWINDOW);l=!1,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,_(u)];case 2:return d=e.sent(),l=d.subwindowCommonModule,[3,4];case 3:throw S=e.sent(),o.logger.debug(S),s.createLiffError(i.EXCEPTION_IN_SUBWINDOW);case 4:return I=l?f:location.origin,[2,new Promise((function(e){window.addEventListener("message",(function r(n){(function(e){if(e.data&&"string"==typeof e.data.type&&[i.SUB_WINDOW_STATUS.SUBMIT,i.SUB_WINDOW_STATUS.CANCEL].includes(e.data.type))return!0;return!1})(n)&&(window.removeEventListener("message",r),e({status:t,result:a}))})),window.opener.postMessage({status:t,result:a},I)}))];case 5:return n.send({eventName:t,data:r}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return e.sent(),[2,{status:t,result:JSON.stringify(r)}]}}))}))}function B(e){var t,r=L();if(e.origin===r){var n=e.data;if(n){var s,a=n.status,u=n.result;try{s=JSON.parse(u||"{}")}catch(c){s={}}switch(a){case i.SUB_WINDOW_HEALTH_CHECK_MESSAGE:window.clearInterval(U()),x();break;case i.SUB_WINDOW_STATUS.CANCEL:case i.SUB_WINDOW_STATUS.SUBMIT:T(!0),window.clearInterval(U()),window.removeEventListener("message",B),I(a,s),null===(t=W())||void 0===t||t.postMessage({type:a},L());break;default:o.logger.debug("unexpected message")}}}}var P=function(t){return e.__awaiter(void 0,void 0,void 0,(function(){var r,n,o,s;return e.__generator(this,(function(e){if(E())return[2];switch(r=t.context,n=r.eventName,o=r.data,s=b(),n){case i.SUB_WINDOW_STATUS.INIT:R(!o.hasOpener);break;case i.SUB_WINDOW_STATUS.CANCEL:case i.SUB_WINDOW_STATUS.SUBMIT:T(!0),I(n,o),null==s||s.reply(t,{eventName:n});break;case i.SUB_WINDOW_STATUS.CLOSE:!1===E()&&(T(!0),I(i.SUB_WINDOW_STATUS.CLOSE,{})),x()}return[2]}))}))};function M(){window.clearInterval(g),window.clearInterval(U()),window.removeEventListener("message",B)}function R(e){if(void 0===e&&(e=!1),M(),T(!1),e){var t=W();t&&(t.close(),O(null))}}function x(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return(t=b())?[4,t.teardown()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}function H(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,o,u,c,l,d,S,v,w;return e.__generator(this,(function(h){switch(h.label){case 0:return(r=s.extractLiffId(t.url))?(R(!0),[4,x()]):[2,Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"params.url must be liff url"))];case 1:return h.sent(),n=t.url,o=t.appData,(u=new URL(n)).searchParams.append(i.SUB_WINDOW_IDNTIFICATION_KEY,"true"),[4,A()];case 2:return c=h.sent(),u.searchParams.append(f.IDENTIFIER_KEY,c.identification.identifier),u.searchParams.append(f.CRYPTO_KEY,c.identification.cryptoKey),u.hostname=function(t){var r=e.__read(t.split(".")),n=r[0],i=r.slice(1);return e.__spreadArray(["".concat(n,"-ext")],e.__read(i),!1).join(".")}(u.hostname),l=u.toString(),O("ios"!==a.getOS()||s.isIpad()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),[4,_(r)];case 3:if(d=h.sent(),S=d.origin,v=d.subwindowCommonModule,!(w=W()))throw s.createLiffError(i.CREATE_SUBWINDOW_FAILED);return v?(function(e){m=e}(S),c.listen(P),c.setData("appData",o),window.addEventListener("message",B),w.location.href=l,N=function(e,t){var r=W(),n={type:i.SUB_WINDOW_HEALTH_CHECK_MESSAGE};return t&&(n.message=JSON.stringify(t)),window.setInterval((function(){null==r||r.postMessage(n,e)}),i.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}(S,o),p=N,function(e){g=e}(window.setInterval((function(){var e=W();e&&e.closed&&(M(),O(null),!1===E()&&(T(!0),I(i.SUB_WINDOW_STATUS.CLOSE,{})))}),i.SUB_WINDOW_MONITOR_CLOSE_INTERVAL)),[2]):(w.close(),[2])}var N}))}))}var K=null;function j(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,o,a,c,f,l,d,_,S,I,v,g,p,m=this;return e.__generator(this,(function(w){switch(w.label){case 0:if(r=t.msit,n=t.mstChallenge,o=t.reconnectCount,a=void 0===o?0:o,c=function(){return e.__awaiter(m,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(i=1e3,new Promise((function(e){return setTimeout(e,i)})))];case 1:return e.sent(),[4,j({msit:r,mstChallenge:n,onSuccess:t.onSuccess,onError:t.onError,reconnectCount:a+1})];case 2:return e.sent(),[2]}var i}))}))},f=function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];K=null,t.onSuccess.apply(t,e.__spreadArray([],e.__read(r),!1))},l=function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];K=null,t.onError.apply(t,e.__spreadArray([],e.__read(r),!1))},d=Date.now(),null===K&&(K=d),_=d-K,a>=10||_>6e5)return l(s.createLiffError(i.UNKNOWN,"Failed to connect")),[2];w.label=1;case 1:return w.trys.push([1,3,,5]),[4,u.requestWithoutErrorHandling(u.getEndPoint("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:r,mstChallenge:n})})];case 2:return S=w.sent(),[3,5];case 3:return w.sent(),[4,c()];case 4:return w.sent(),[2];case 5:return S.status>=500?[4,c()]:[3,7];case 6:return w.sent(),[3,17];case 7:return S.status>=400&&500>S.status?[4,q(S)]:[3,9];case 8:return v=w.sent(),I=v?s.createLiffError(i.INVALID_ARGUMENT,v.errorDetail):s.createLiffError(i.UNKNOWN,"Some error happened in the server"),l(I),[3,17];case 9:return 200!==S.status?[3,16]:[4,q(S)];case 10:if(!(v=w.sent()))return l(s.createLiffError(i.UNKNOWN,"Some error happened in the server")),[2];switch(g=v.status,p=v.result,g){case i.SUB_WINDOW_STATUS.ERROR:return[3,11];case i.SUB_WINDOW_STATUS.CLOSE:case i.SUB_WINDOW_STATUS.CANCEL:case i.SUB_WINDOW_STATUS.SUBMIT:return[3,13]}return[3,14];case 11:return[4,c()];case 12:return w.sent(),[3,15];case 13:return f(g,p),[3,15];case 14:l(s.createLiffError(i.UNKNOWN,"Some error happened in the server")),w.label=15;case 15:return[3,17];case 16:l(s.createLiffError(i.UNKNOWN,"Some error happened in the server")),w.label=17;case 17:return[2]}}))}))}function q(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,t.json()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}}))}))}function G(e){var t={};return Object.keys(e).forEach((function(r){"closeButtonColor"===r?"white"===e[r]?t[r]="#ffffff":t[r]="#000000":t[r]=e[r]})),t}var V={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function J(e){var t=e.appData,r=e.native,n=c.getConfig().liffId,o=c.getMSTChallenge(),a=s.extractLiffId(e.url);if(!n)return Promise.reject(s.createLiffError(i.UNAUTHORIZED,"liffId is invalid"));if(!o)return Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst_challenge is invalid"));if(!a)return Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"params.url must be liff url"));var f=Object.assign({},V,r);return function(e){var t=e.mainLiffId,r=e.subLiffId,n=e.mstChallenge,o=e.appData,a=e.view;return t&&n?u.fetch(u.getEndPoint("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:r,mstChallenge:n,appData:o,view:a})}):Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"))}({mainLiffId:n,subLiffId:a,mstChallenge:o,appData:t,view:G(f)}).then((function(t){var r=t.msit;j({msit:r,mstChallenge:o,onSuccess:function(e,t){I(e,t)},onError:function(e){I(i.SUB_WINDOW_STATUS.ERROR,e)}}),function(e,t){var r=e.url,n=new URLSearchParams;n.set("msit",t),location.href="".concat(i.SUB_WINDOW_MODAL_SCHEME_URL,"?url=").concat(encodeURIComponent(r),"&").concat(n.toString())}(e,r)}))}function k(e){if(!e.mst||!e.status)return Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"));var t=JSON.stringify(e);return u.fetch(u.getEndPoint("subWindowPost"),{method:"POST",body:t})}function Z(){if(!l.isSubWindow())throw s.createLiffError(i.UNAUTHORIZED,"this api can be only called in child window")}var F={on:function(e,t){S[e]||(S[e]=[]),S[e].push(t)},off:function(e,t){if(S[e]){var r=S[e].indexOf(t);r>=0&&S[e].splice(r,1)}},open:function(e){return n.validators.subwindowOpen(),r.isInClient()?J(e):H(e)},cancel:function(t){return void 0===t&&(t={}),Z(),r.isInClient()?function(t){return void 0===t&&(t={}),e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:return(r=c.getMST())?[4,k({mst:r,status:i.SUB_WINDOW_STATUS.CANCEL,result:t})]:[2,Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst is invalid"))];case 1:return n=e.sent(),T(!0),[2,n]}}))}))}(t):function(e){return void 0===e&&(e={}),y(i.SUB_WINDOW_STATUS.CANCEL,e)}(t)},submit:function(t){return void 0===t&&(t={}),Z(),r.isInClient()?function(t){return void 0===t&&(t={}),e.__awaiter(this,void 0,void 0,(function(){var r,n;return e.__generator(this,(function(e){switch(e.label){case 0:return(r=c.getMST())?[4,k({mst:r,status:i.SUB_WINDOW_STATUS.SUBMIT,result:t})]:[2,Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst is invalid"))];case 1:return n=e.sent(),T(!0),[2,n]}}))}))}(t):function(e){return void 0===e&&(e={}),y(i.SUB_WINDOW_STATUS.SUBMIT,e)}(t)},close:function(){return Z(),r.isInClient()?function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return!1!==E()?[3,2]:(t=c.getMST())?[4,k({mst:t,status:i.SUB_WINDOW_STATUS.CLOSE,result:{}})]:[2,Promise.reject(s.createLiffError(i.UNAUTHORIZED,"mst is invalid"))];case 1:e.sent(),e.label=2;case 2:return d.closeWindow(),[2]}}))}))}():function(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){return(null==(t=b())?void 0:t.isReady())?(t.send({eventName:i.SUB_WINDOW_STATUS.CLOSE}),[2,new Promise((function(e){setTimeout((function(){d.closeWindow(),e()}),i.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}))]):(d.closeWindow(),[2,Promise.resolve()])}))}))}()},getAppData:function(){return Z(),function(){var e,t=c.getAppData();try{e=t?JSON.parse(t):{}}catch(r){e={}}return Promise.resolve(e)}()}},Y=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e.__extends(r,t),Object.defineProperty(r.prototype,"name",{get:function(){return"subWindow"},enumerable:!1,configurable:!0}),r.prototype.install=function(){return F},r}(t.LiffModule);exports.SubWindowModule=Y,exports.getAppData=function(e){var t=e.mst;return t?u.fetch(u.getEndPoint("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"))},exports.getMSTByMSIT=function(e){var t=e.msit,r=e.mstVerifier;return t&&r?u.fetch(u.getEndPoint("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:r})}):Promise.reject(s.createLiffError(i.INVALID_ARGUMENT,"no proper argument"))},exports.getMainWindowOrigin=C,exports.getMessageBus=b,exports.initMessageBus=A,exports.setMainWindowOrigin=function(e){D.setItem("mainWindowOrigin",e)},exports.subWindow=F;
