import{__assign as e,__awaiter as t,__generator as n,__read as r,__extends as o}from"tslib";import{LiffModule as i}from"@liff/use";import{done as a}from"@liff/ready";import{isLoggedIn as s}from"@liff/is-logged-in";import{convertHexToRgb as c,convertArgbToRgba as l,createLiffError as f,base64Url as u,convertArrayBuffer as d,compareVersion as h,qs as p,extractChannelIdFromLiffId as v,objectAssignKeyOnlyWithValue as m,addParamsToUrl as w,randomAlphaNumericString as b,replaceUrlCredentialRemoved as g}from"@liff/util";import{getContext as k,getLoginTmp as C,getExpireTime as F,getIsSubsequentLiffApp as I,getFeatureToken as y,setIsSubsequentLiffApp as _,getMST as B,getAccessToken as S,getRawContext as x,getIDToken as T,getClientId as A,getMSTChallenge as E,getMSTVerifier as L,getMSIT as N,getConfig as U,setDecodedIDToken as D,setAppData as O,setMST as P,setFeatureToken as W,setAccessToken as j,setContext as H,setMSTChallenge as K,setMSTVerifier as M,setClientId as R,setMSIT as J,setIDToken as V,getDecodedIDToken as q,removeLoginTmp as z,setExpireTime as G,setConfig as Q}from"@liff/store";import{CheckAvailability as X}from"@liff/check-availability";import{FORBIDDEN as Y,INIT_FAILED as Z,INVALID_ID_TOKEN as $,SUB_WINDOW_STATUS as ee,SUB_WINDOW_HEALTH_CHECK_MESSAGE as te,INVALID_CONFIG as ne}from"@liff/consts";import{load as re}from"@liff/extensions";import{isInClient as oe}from"@liff/is-in-client";import{logout as ie}from"@liff/logout";import{isSubWindow as ae}from"@liff/is-sub-window";import{getMSTByMSIT as se,getAppData as ce,getMainWindowOrigin as le,getMessageBus as fe,initMessageBus as ue,setMainWindowOrigin as de}from"@liff/sub-window";import{fetch as he,getEndPoint as pe,verifyAccessToken as ve}from"@liff/server-api";import{logger as me}from"@liff/logger";import{getLineVersion as we}from"@liff/get-line-version";import{addListener as be,removeListener as ge}from"@liff/native-bridge";import{isApiAvailable as ke}from"@liff/is-api-available";import{getOS as Ce}from"@liff/get-os";import{login as Fe}from"@liff/login";import{closeWindow as Ie}from"@liff/close-window";import{EVENT_NAME as ye,WINDOW as _e,IDENTIFIER_KEY as Be}from"@liff/message-bus";import{AsyncHook as Se}from"@liff/hooks";import{t as xe}from"@liff/i18n";var Te={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},Ae={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function Ee(){var e;Ue("color-scheme",((null==(e=k())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");Le({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",Le):t.addListener&&t.addListener(Le)}function Le(t){var n=k(),r=(null==n?void 0:n.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:Te,darkModeColor:Ae},o=r.adaptableColorSchemes,i=r.lightModeColor,a=r.darkModeColor,s=o.includes("dark");t.matches&&s?Ne(e(e({},Ae),a)):Ne(e(e({},Te),i))}function Ne(e){var t=e.iconColor,n=e.statusBarColor,r=e.titleTextColor,o=e.titleSubtextColor,i=e.titleButtonColor,a=e.titleBackgroundColor,s=e.progressBarColor,f=e.progressBackgroundColor,u=e.titleButtonAreaBackgroundColor,d=e.titleButtonAreaBorderColor,h=e.baseBackgroundColor,p=e.baseTextColor,v=e.lightButtonBorderColor;Ue("--liff-base-background-color",h),Ue("--liff-base-text-color",p),Ue("--liff-base-background-rgb-color",c(h)),Ue("--liff-base-text-rgb-color",c(p)),Ue("--liff-light-button-border-color",v),Ue("--liff-title-text-color",r),Ue("--liff-title-background-color",a),Ue("--liff-title-button-color",i),Ue("--liff-icon-color",t),Ue("--liff-status-bar-color",n),Ue("--liff-title-subtext-color",o),Ue("--liff-progress-bar-color",s),Ue("--liff-progress-background-color",f),Ue("--liff-title-button-area-background-color",l(u)),Ue("--liff-title-button-area-border-color",l(d))}function Ue(e,t){document.documentElement.style.setProperty(e,t)}var De={addToHomeScreen:function(e){if(!new X(e).invoke("addToHomeScreen"))throw f(Y,"No permission for liff.addToHomeScreen()")},scanCode:function(e){if(!new X(e).invoke("scanCode"))return Promise.reject(f(Y,"No permission for liff.scanCode()"))},getAdvertisingId:function(e){if(!new X(e).invoke("getAdvertisingId"))return Promise.reject(f(Y,"No permission for liff.getAdvertisingId()"))},initPlugins:function(){}};function Oe(e){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,re()];case 1:return(t=n.sent())?(t.install(e,De),[2]):[2]}}))}))}function Pe(){return t(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,he(pe("certs"))];case 1:return[2,e.sent()]}}))}))}function We(e,r,o){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 1:return t=n.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},t,o,r)];case 2:return[2,n.sent()]}}))}))}function je(e,o){return t(this,void 0,void 0,(function(){var t,i,a,s,c,l,h,p,v,m,w,b,g,k,C,F;return n(this,(function(n){switch(n.label){case 0:return t=e.split("."),i=r(t,3),a=i[0],s=i[1],c=i[2],l=JSON.parse(u.decode(a)),h=JSON.parse(u.decodeUnicode(s)),p=d(u.decode(c)),v=d("".concat(a,".").concat(s)),[4,Pe()];case 1:if(m=n.sent(),!(w=m.keys.find((function(e){return e.kid===l.kid}))))return[3,6];if(delete w.alg,"ES256"!==l.alg)throw f($,'Invalid "alg" value in ID_TOKEN');b=void 0,n.label=2;case 2:return n.trys.push([2,4,,5]),[4,We(w,v,p)];case 3:return b=n.sent(),[3,5];case 4:throw g=n.sent(),f($,"".concat("Failed to use Crypto API to verify ID_TOKEN",": ").concat(g));case 5:if(b){if(k=h.iss!=="https://access.".concat("line.me"),C=h.aud!==o,F=1e3*h.exp<Date.now(),k)throw f($,'Invalid "iss" value in ID_TOKEN');if(C)throw f($,'Invalid "aud" value in ID_TOKEN');if(F)throw f($,'Invalid "exp" value in ID_TOKEN');return[2,h]}throw f($,"Invalid signature in ID_TOKEN");case 6:throw f($,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function He(e){var t=e.split(".");if(t[1])try{var n=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(n))}catch(r){return null}return null}function Ke(e){var t=e.pathname,n=e.query,r=n?"?".concat(p.stringify(n)):"",o="".concat("liff://").concat(t).concat(r);location.href=o}var Me=null;function Re(){"boolean"==typeof Me&&me.warn("liff.init is not expected to be called more than once"),Me=!!I()||!(!oe()||p.parse(window.location.hash).feature_token||y())&&(_(!0),!0)}function Je(){return Boolean(Me)}function Ve(e,r){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return(t=B())?[2,t]:e&&r?[4,se({msit:e,mstVerifier:r})]:[3,2];case 1:return[2,n.sent().mst];case 2:return[2,null]}}))}))}function qe(e){return he("".concat(pe("apps"),"/").concat(e,"/featureToken"))}function ze(e){return t(this,void 0,void 0,(function(){var t,r,o,i;return n(this,(function(n){switch(n.label){case 0:return t=p.parse(window.location.hash),r=m({access_token:S(),context_token:x(),feature_token:y(),id_token:T(),client_id:A(),mst_challenge:E(),mst_verifier:L(),msit:N()},t),Je()?s()?[4,qe(e)]:[3,2]:[3,3];case 1:o=n.sent().featureToken,r.feature_token||(r.feature_token=o),n.label=2;case 2:(i=v(e))&&(r.client_id=i),n.label=3;case 3:return[2,r]}}))}))}function Ge(e){if(e.persisted&&ke("multipleLiffTransition"))if("ios"===Ce())window.location.reload();else{var t=U().liffId,n=y();if(!t)throw f(Z,"Invalid LIFF ID.");if(!n)throw f(Y,"Invalid featureToken for client features");Ke({pathname:"app/".concat(t),query:{feature_token:n}})}}function Qe(e,r){return t(this,void 0,void 0,(function(){var t,o;return n(this,(function(n){switch(n.label){case 0:return[4,ve(e)];case 1:return t=n.sent().client_id,o=v(r),[2,t===o]}}))}))}function Xe(e){var r,o;return t(this,void 0,void 0,(function(){var t,i,a,c,l,u,d,p,v,m,b,g,C;return n(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(e){var t=we();if(!t||h(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{me.debug("cannot find window._liff.features, listen to ready event");var n=function(){me.debug("ready event is fired"),ge("ready",n),e()};be("ready",n)}}))];case 1:return n.sent(),Re(),[4,ze(e.liffId)];case 2:if(t=n.sent(),i=t.access_token,a=t.context_token,c=t.feature_token,l=t.id_token,u=t.client_id,d=t.mst_verifier,p=t.mst_challenge,v=t.msit,a){if("string"!=typeof a)throw f(Z,"Cannot get context token, perhaps there is an incorrect parameter in permanent link");H(He(a))}if(void 0!==(null===(r=k())||void 0===r?void 0:r.liffId)&&(null===(o=k())||void 0===o?void 0:o.liffId)!==e.liffId)throw f(Z,"Invalid LIFF ID");return!ae()&&c&&(!function(e,t){ke("multipleLiffTransition")&&Ke({pathname:"app/".concat(e),query:{feature_token:t}})}(e.liffId,c),Je()&&W(c)),p&&K(p),d&&M(d),u&&R(u),v&&J(v),window.addEventListener("pageshow",Ge),s()?[3,7]:c&&i?[3,5]:Je()?(m=w(location.href,{"liff.hback":"2"}),Fe({redirectUri:m}),[4,new Promise((function(){}))]):[3,4];case 3:n.sent(),n.label=4;case 4:throw Fe(),f(Z,"Failed to parse feature_token or access_token");case 5:return[4,Qe(i,e.liffId)];case 6:if(!n.sent())throw Fe(),f(Z,"Failed to verify access_token");W(c),j(i),n.label=7;case 7:return[4,Ve(v,d)];case 8:return(b=n.sent())?(P(b),[4,ce({mst:b})]):[3,10];case 9:(g=n.sent().data)&&O(JSON.stringify(g)),n.label=10;case 10:return l&&!T()&&V(l),l&&u&&!q()?[4,je(l,u)]:[3,12];case 11:(C=n.sent())&&D(C),n.label=12;case 12:return[2]}}))}))}function Ye(e){return t(this,void 0,void 0,(function(){var t,r,o,i,a,s,c;return n(this,(function(n){switch(n.label){case 0:return t=pe("apps"),r="".concat(t,"/").concat(e,"/contextToken"),o=S(),i={"Content-Type":"application/json",Accept:"application/json"},o&&(i.Authorization="Bearer ".concat(o)),[4,he(r,{headers:i})];case 1:if(a=n.sent(),!(s=a.contextToken))throw f(Z,"Can not get context from server.");if(!(c=He(s)))throw f(Z,"Invalid context token.");return[2,c]}}))}))}function Ze(){return t(this,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:if(!(e=U().liffId))throw f(Z,"Invalid LIFF ID.");return[4,Ye(e)];case 1:return t=n.sent(),H(t),[2]}}))}))}function $e(e){return t(this,void 0,void 0,(function(){var r,o,i,a=this;return n(this,(function(s){switch(s.label){case 0:r=function(){return t(a,void 0,void 0,(function(){var t,r,o,i,a,s;return n(this,(function(n){switch(n.label){case 0:return[4,(c=U(),l=p.parse(window.location.search),f=C(),u={grant_type:"authorization_code",client_id:l.liffClientId,appId:c.liffId,code:l.code,code_verifier:f.codeVerifier,redirect_uri:c.redirectUri||l.liffRedirectUri,id_token_key_type:"JWK"},d=p.stringify(u),he(pe("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:d}))];case 1:return t=n.sent(),r=t.access_token,o=t.id_token,i=t.expires_in,R(e),j(r),G(new Date(Date.now()+1e3*i)),z(),o?(V(o),[4,je(o,e)]):[3,3];case 2:(a=n.sent())&&D(a),n.label=3;case 3:return(s=p.parse(location.hash).context_token)?(H(He(s)),[3,6]):[3,4];case 4:return[4,Ze()];case 5:n.sent(),n.label=6;case 6:return[2]}var c,l,f,u,d}))}))},s.label=1;case 1:return s.trys.push([1,3,,4]),[4,r()];case 2:return s.sent(),[3,4];case 3:throw o=s.sent(),i=o,z(),i;case 4:return[2]}}))}))}function et(){return t(this,void 0,void 0,(function(){var e,r,o,i,a,c,l=this;return n(this,(function(f){switch(f.label){case 0:return(r=fe())?[3,2]:[4,ue(_e.SUB)];case 1:r=f.sent(),f.label=2;case 2:return(e=r).isReady()?(o=b(8),[4,e.getData("appData")]):[3,8];case 3:return i=f.sent(),a=i.eventName,c=i.data,a!==ye.NOT_FOUND?[3,6]:[4,e.teardown()];case 4:return f.sent(),[4,et()];case 5:return[2,f.sent()];case 6:c&&O(JSON.stringify(c)),f.label=7;case 7:return e.listen((function(r){return t(l,void 0,void 0,(function(){var t,i;return n(this,(function(n){return t=r.context,i=t.data,t.eventName===ee.INIT&&(null==i?void 0:i.subWindowId)!==o&&Ie(),t.eventName!==ee.CANCEL&&t.eventName!==ee.SUBMIT||e.teardown(),[2]}))}))})),s()&&e.send({eventName:ee.INIT,data:{subWindowId:o,hasOpener:!!window.opener}}),[3,10];case 8:return le()?[3,10]:[4,new Promise((function(e){window.addEventListener("message",function(e){return function t(n){var r=n.data,o=n.source,i=n.origin;if(r){var a=r.type,s=r.message;a===te&&(window.removeEventListener("message",t),s&&O(s),de(i),o&&o.postMessage&&o.postMessage({status:te},i),e())}}}(e))}))];case 9:return[2,f.sent()];case 10:return[2]}}))}))}var tt=new(function(){function e(){var e=this;this.getAndValidateContext=function(){var e=k();if(!e)throw f(Z,"Could not get Context from server.");if(!e.endpointUrl)throw f(Z,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw f(Z,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var n=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var r=!n.endpointUrl.startsWith("/?")&&n.endpointUrl.includes("/?")||!n.endpointUrl.startsWith("/#")&&n.endpointUrl.includes("/#")||n.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(n.endpointUrl),i=o.origin,a=o.pathname,s=o.search,c=new URL("".concat(i).concat(e.attachSlashAtStart(t))),l=c.pathname,f=c.search,u=c.hash,d="".concat(s).concat(s?f.replace(/\?/g,"&"):f),h="".concat(a).concat(e.attachSlashAtStart(l)).replace("//","/");return(h=e.attachSlashAtStart("".concat(h))).endsWith("/")&&!r&&(h=h.substring(0,h.length-1)),"".concat(i).concat(h).concat(d).concat(u).replace(/%0D%0A/g,"\n")}}return e.prototype.attachSlashAtStart=function(e){return"".concat(e&&e.length>0&&!e.startsWith("/")?"/":"").concat(e)},e.prototype.invoke=function(){return t(this,void 0,void 0,(function(){var e,t,r,o,i;return n(this,(function(n){switch(n.label){case 0:if(e=p.parse(window.location.search),"string"!=typeof(t=e["liff.state"]))return[2];n.label=1;case 1:return n.trys.push([1,4,,5]),r=location.href,(o=this.decodeState(t))===r?[3,3]:(e["liff.hback"]?location.replace(w(o,{"liff.hback":e["liff.hback"]})):location.replace(o),[4,new Promise((function(){}))]);case 2:n.sent(),n.label=3;case 3:return[3,5];case 4:if((i=n.sent()).code===Z)throw i;return me.debug(i),[3,5];case 5:return[2]}}))}))},e}());function nt(e,r){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:if(!e.liffId)throw f(ne,"liffId is necessary for liff.init()");return Q(e),!oe()&&s()&&(F()||ie()),t=p.parse(window.location.search),!ae()||oe()?[3,2]:[4,et()];case 1:n.sent(),n.label=2;case 2:if(t.error&&t.liffOAuth2Error)throw a=t.error,c=t.error_description,l=c.replace(/\+/g," "),u="".concat(a,": ").concat(l),f(Z,u);return o=t.code,i=C(),Boolean(o&&!s()&&i&&i.codeVerifier)?[4,$e(t.liffClientId)]:[3,4];case 3:n.sent(),n.label=4;case 4:return oe()?[4,Xe(e)]:[3,6];case 5:return n.sent(),[3,8];case 6:return s()?[3,8]:[4,Ze()];case 7:n.sent(),n.label=8;case 8:return[4,tt.invoke()];case 9:return n.sent(),[4,r()];case 10:return n.sent(),g(window.location.href),[2]}var o,i,a,c,l,u}))}))}var rt=function(e,t){return new Promise((function(n,r){if(e){var o=document.createElement("script");o.type="module",o.onload=function(){n()},o.src=e,document.head.appendChild(o)}else r(f(ne,t))}))},ot=function(e){var t="https://static.line-scdn.net/lui/edge/versions/1.13.0/lui-alert.js";return t&&e&&(t=t.replace(/\d{1,2}\.\d{1,2}\.\d{1,3}/,e)),rt(t,"LUI_ALERT_URL is not defined")},it=function(){return t(void 0,void 0,void 0,(function(){var e;return n(this,(function(t){switch(t.label){case 0:return e=function(){var e,t=document.querySelector('script[src*="luivendor.js"]');if(t&&(null===(e=t.src.match(/\d{1,2}\.\d{1,2}\.\d{1,3}/g))||void 0===e?void 0:e.length))return t.src.match(/\d{1,2}\.\d{1,2}\.\d{1,3}/g)[0]}(),e?[3,2]:[4,rt("https://static.line-scdn.net/lui/edge/versions/1.13.0/luivendor.js","LUI_VENDOR_URL is not defined")];case 1:t.sent(),t.label=2;case 2:return[4,ot(e)];case 3:return t.sent(),[4,(n=b(6),new Promise((function(){var e=document.createElement("div");e.innerHTML='<lui-alert id="'.concat("liffAlert","-").concat(n,'" shown title="').concat(xe("alert.android.extBrowser.autoLoginWorkaround.title"),'" message="').concat(xe("alert.android.extBrowser.autoLoginWorkaround.desc"),'" button="').concat(xe("alert.android.extBrowser.autoLoginWorkaround.button.text"),'"></lui-alert>'),document.body.appendChild(e);var t=document.getElementById("".concat("liffAlert","-").concat(n));t&&t.addEventListener("lui-button-click",(function(){var e=window.open("".concat(window.location.href,"&liffIsEscapedFromApp=true"),"_blank");e&&(e.location.href="".concat(window.location.href,"&liffIsEscapedFromApp=true"),window.close())}))})))];case 4:return t.sent(),[2]}var n}))}))};function at(){return t(this,void 0,void 0,(function(){var e;return n(this,(function(t){switch(t.label){case 0:return oe()||"android"!==Ce()||((e=p.parse(window.location.search))[Be]||e.liffIsEscapedFromApp)?[3,6]:e.liffClientId&&document.referrer.includes("access.".concat("line.me"))?(window.location.href="".concat(window.location.href,"&liffIsEscapedFromApp=true"),[2]):e.liffClientId&&document.referrer.includes("android-app://")?[4,it()]:[3,2];case 1:t.sent(),t.label=2;case 2:return e.liffClientId&&""===document.referrer&&1===window.history.length?[4,it()]:[3,4];case 3:t.sent(),t.label=4;case 4:return!document.referrer.includes("liffClientId")||document.referrer.includes("liffIsEscapedFromApp")?[3,6]:[4,it()];case 5:t.sent(),t.label=6;case 6:return[2]}}))}))}var st=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.hooks={before:new Se,after:new Se},t.internalHooks={beforeFinished:new Se,beforeSuccess:new Se,error:new Se},t}return o(r,e),Object.defineProperty(r.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),r.prototype.install=function(e){var t=e.liff;return this.liffForWindow=t,this.init.bind(this)},r.prototype.init=function(e,r,o){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return[4,this.hooks.before.call()];case 1:n.sent(),i=this.liffForWindow,window&&!window.liff&&(window.liff=i),n.label=2;case 2:return n.trys.push([2,9,,11]),[4,Promise.all([Oe(this.liffForWindow),nt(e,this.internalHooks.beforeFinished.call)])];case 3:return n.sent(),Ee(),[4,this.internalHooks.beforeSuccess.call()];case 4:return n.sent(),!e.withLoginOnExternalBrowser||s()?[3,6]:(Fe(),[4,new Promise((function(){}))]);case 5:n.sent(),n.label=6;case 6:return[4,at()];case 7:return n.sent(),[4,this.hooks.after.call()];case 8:return n.sent(),"function"==typeof r&&r(),a(),[3,11];case 9:return t=n.sent(),[4,this.internalHooks.error.call(t)];case 10:throw n.sent(),"function"==typeof o&&o(t),t;case 11:return[2]}var i}))}))},r}(i);export{st as InitModule};
